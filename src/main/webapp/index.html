<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>SalStocks</title>
	<link rel="stylesheet" type="text/css" href="search6.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://kit.fontawesome.com/3500178f9e.js" crossorigin="anonymous"></script>
	<script>
		function search(){
			var loggedIn = sessionStorage.getItem("loggedIn");
			if(loggedIn=="true"){
				loggedInSearch();
			}else{
				loggedOutSearch();
			}
		}
		
		function login(){
			//TODO do login
			sessionStorage.setItem("loggedIn", true);
		}
		
		function loggedInSearch(){
			$.ajax({
		 		url: "Search",
		 		data:{
		 			query: document.searchForm.searchField.value
		 		},
		 		success: function(result){
		 			if(result.hasOwnProperty('error')){
			 			$(errorDiv).html("<h2>"+result.errorMessage+"<\h2>");
		 			}else{//Display the stock data
		 				
		 				console.log(result);//TODO delete
		 				
		 				//put the name of the ticker in session storage
		 				sessionStorage.setItem("ticker", result.ticker);
		 						 				
		 				var lastStyle="";
		 				var percentStyle="";
		 				var caretSrc="";
						var starSrc="star.svg";
						var timeStamp="placeholder timestamp" //TODO
						var time = new Date();
						var timeString =time.toLocaleString('en-US', {hour :'numeric', year: 'numeric', month:'numeric', day:'numeric', hour12: false, minute:'numeric', second:'numeric'});
						console.log(timeString);
						var hoursText= "<text class=\"redHours\">Market Closed on "+timeString+"</text>";
		 				
		 				if(result.percentChange>=0){
		 					lastStyle = "greenLast";
		 					percentStyle = "greenPercent";
		 					caretSrc="caret-up.png";
		 				}else{
		 					lastStyle = "redLast"
		 					percentStyle = "redPercent";
		 					caretSrc="caret-down.png";
		 				}
		 				
		 				if(result.marketOpen){
		 					hoursText="<text class=\"greenHours\">Market Open</text>";
		 				}
		 				
		 				//Sets the session storage variable of if this ticker is already a favorite and updates the image
						isFavorite(sessionStorage.getItem("ticker"));
		 				
		 				
		 				var openDetails="\
						<p class=\"lmid\">Mid Price: "+result.mid+"</p>\
						<p class=\"laskp\">Ask Price: "+result.askPrice+"</p>\
						<p class=\"lasks\">Ask Size: "+result.askSize+"</p>\
						<p class=\"lbidp\">Bid Price: "+result.bidPrice+"</p>\
						<p class=\"lbids\">Bid Size: "+result.bidSize+"</p>\
						";
		 				
		 				
		 				$(homeDiv).html("\
		 						<div class=\"info\">\
		 						<text id=\"lticker\" class=\"lticker\">"+result.ticker+"</text>\
		 						<div id = \"starimage\"></div>\
		 						<text class=\""+lastStyle+"\">"+result.last+"</text>\
		 						<br>\
		 						<br>\
		 						<br>\
		 						<text class=\""+percentStyle+"\">"+result.change+" ("+result.percentChange+")%</text>\
		 						<img src=\""+caretSrc+"\" class=\"caret\"\>\
		 						<text class=\"lname\">"+result.name+"</text>\
		 						<br>\
		 						<br>\
		 						<br>\
		 						<text class=\"ltimestamp\">"+timeStamp+"</text>\
		 						<text class=\"lexchangeCode\">"+result.exchangeCode+"</text>\
		 						<br>\
		 						<br>\
		 						<text class=\"lquantity\">Quantity: <input type=\"number\" id=\"buyField\" class=\"buyfield\"></text>\
		 						<br>\
		 						<br>\
		 						<button type=\"button\" class=\"buyButton\" value=\"Buy!\" onClick=\"buy()\">Buy</button>\
		 						<br>\
		 						<br>\
		 						<br>\
		 						<text class=\"greenHours\">"+hoursText+"</text>\
		 						<br>\
		 						<text class=\"summary\">Summary</text>\
		 						<br>\
		 						<hr class = \"lineDivide\">\
		 						<br>\
		 						<br>\
		 						<text class=\"lhigh\">High Price: "+result.high+"</text>\
		 						<text class=\"llow\">Low Price: "+result.low+"</text>\
		 						<text class=\"lopen\">Open Price: "+result.open+"</text>\
		 						<p class=\"lclose\">Prev. Close: "+result.prevClose+"</p>\
		 						<p class=\"lvolume\">Volume: "+result.volume+"</p>\
		 						"+openDetails+ "<br>\
		 						<br>\
		 						<p class=\"descriptionTitle\"><b>Company's Description</b></p>\
		 						<br>\
		 						<p class=\"startDate\">Start Date: "+result.startDate+"</p>\
		 						<br>\
		 						<p class=\"description\">"+result.description+"</p>\
		 						</div>\
		 						");
		 			}
		 		}
		 	});
		}
		
		function loggedOutSearch(){
			$.ajax({
		 		url: "Search",
		 		data:{
		 			query: document.searchForm.searchField.value
		 		},
		 		success: function(result){
		 			if(result.hasOwnProperty('error')){
			 			$(errorDiv).html("<h2>"+result.errorMessage+"<\h2>");
		 			}else{//Display the stock data
		 				console.log(result)
		 				$(homeDiv).html("\
		 						<div class=\"info\">\
		 						<p class=\"ticker\">"+result.ticker+"</p>\
		 						<br>\
		 						<p class=\"name\">"+result.name+"</p>\
		 						<br>\
		 						<p class=\"exchangeCode\">"+result.exchangeCode+"</p>\
		 						<br>\
		 						<br>\
		 						<p class=\"summary\">Summary</p>\
		 						<br>\
		 						<hr class = \"lineDivide\">\
		 						<br>\
		 						<br>\
		 						<p class=\"high\">High Price: "+result.high+"</p>\
		 						<p class=\"low\">Low Price: "+result.low+"</p>\
		 						<p class=\"open\">Open Price: "+result.open+"</p>\
		 						<p class=\"close\">Close: "+result.close+"</p>\
		 						<p class=\"volume\">Volume: "+result.volume+"</p>\
		 						<br>\
		 						<br>\
		 						<p class=\"descriptionTitle\"><b>Company's Description</b></p>\
		 						<br>\
		 						<p class=\"startDate\">Start Date: "+result.startDate+"</p>\
		 						<br>\
		 						<p class=\"description\">"+result.description+"</p>\
		 						</div>\
		 						");
		 			}
		 		}
		 	});
		}
		
		function buy(){
			console.log("buying "+ document.getElementById("buyField").value);
		}
		
		function isFavorite(ticker){
			var ticker = sessionStorage.getItem("ticker");
			var user_id = sessionStorage.getItem("user_id");
			$.ajax({
				url:"IsFavorite",
				data: {
					ticker: ticker,
					user_id: user_id
				},
				success: function(res){
					console.log(res);
					if(res.favorite=="true"){
						document.getElementById("starimage").innerHTML="<input type=\"image\" class=\"starFormat\" src = \"filledstar.png\" onClick=\"favorite()\"\>";
						sessionStorage.setItem("tickerFavorite", "true");
					}else{
						document.getElementById("starimage").innerHTML="<input type=\"image\" class=\"starFormat\" src = \"star.svg\" onClick=\"favorite()\"\>";
						sessionStorage.setItem("tickerFavorite", "true");
					}
				}
			});
		}
		
		function favorite(){
			var ticker = sessionStorage.getItem("ticker");
			var user_id = sessionStorage.getItem("user_id");
			console.log("ticker is "+sessionStorage.getItem("tickerFavorite"));
			if(sessionStorage.getItem("tickerFavorite")=="true"){
				//TODO move the changing image into the onsuccess of the GET/POS
				console.log("setting ticker to unfavorate");
				removeFavorite(ticker, user_id);
			}else{
				//TODO move the changing image into the onsuccess of the GET/POS
				console.log("setting ticker to favorate");
				addFavorite(ticker, user_id);
			}
		}
		
		function removeFavorite(){
			var ticker = sessionStorage.getItem("ticker");
			var user_id = sessionStorage.getItem("user_id");
			$.ajax({
				url:"RemoveFavorite",
				data: {
					ticker: ticker,
					user_id: user_id
				},
				success: function(res){
					if(res.removed=="true"){
						document.getElementById("starimage").innerHTML="<input type=\"image\" class=\"starFormat\" src = \"star.svg\" onClick=\"favorite()\"\>";
						sessionStorage.setItem("tickerFavorite", "false");
					}else{
						document.getElementById("starimage").innerHTML="<input type=\"image\" class=\"starFormat\" src = \"filledstar.png\" onClick=\"favorite()\"\>";
						}
				}
			});
		}
		
		function addFavorite(ticker, user_id){
			$.ajax({
				url:"AddFavorite",
				data: {
					ticker: ticker,
					user_id: user_id
				},
				success: function(res){
					if(res.success=="true"){
						document.getElementById("starimage").innerHTML= "<input type=\"image\" class=\"starFormat\" src = \"filledstar.png\" onClick=\"favorite()\"\>";
						sessionStorage.setItem("tickerFavorite", "true");
					}else{
						alert("Sorry, something went wrong, and we couldn't favorite this stock!");
					}
				}
			});
		}
	 
	 
	 
	</script> 
</head>
<body>

	<div id="homeDiv" class="homeDiv">
		<h1 id="title" class="title">STOCK SEARCH</h1>
		<form name="searchForm" method ="GET" action = "search();" id="search-form">
			<div class="search">
				<input type="text" class="round" id="searchField" name="searchField" placeholder="Enter stock ticker">
				<input type="button" class ="corner" onclick="search()" id="searchButton" name="searchButton">
			</div>
		</form>		
		<div id="errorDiv" class = "error"></div>
		
	</div>
	
		
	
	<script> 
        $(window).ready(function() {
        $("#search-form").on("keypress", function (event) {
            var keyPressed = event.keyCode || event.which;
            if (keyPressed === 13) {
                event.preventDefault();
                search();
                return false;
            }
        });
        });
        
        window.onload = function () {
            if (sessionStorage.getItem("hasCodeRunBefore") === null) {
            	sessionStorage.setItem("loggedIn", "true");//TODO change back to false
            	sessionStorage.setItem("user_id", "1");//TODO delete this and do it only when the user is successfully logged in
            	sessionStorage.setItem("hasCodeRunBefore", true);
            }
        }
    </script> 



</body>
</html>